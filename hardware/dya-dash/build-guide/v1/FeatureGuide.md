# Feature Guide

DYA Dash を使ったりソフトウェアを改造したりする上で知っておくと良さそうな内容を走り書きしたページです。

> [!WARNING]
> 以下の内容は v1.0 試作版向けに書かれています。

## 左右の役割

- 右手側のキーボードが親機として動きます。PC と有線接続する場合は右側の XIAO に USB ケーブルを接続してください。
- 左手側のキーボードは子機として右手のキーボードと通信しています。左手の XAIO に USB ケーブルを接続した場合は電源供給のみが行われます。
- キーボードには　 XAIO の USB ポートに加えて左右接続用の USB ポートがありますが、有線での左右接続にはまだ未対応です。今のところ電源供給（XIAO の USB ポートから入力された電源をもう片方のキーボードにバイパスする）用途でのみ使用できます。

## デフォルトのキー配列

- デフォルトでは下の写真のようなキー配列になっています。
- 左手親指のキーを押した状態(Left SPACE layer)で入力すると数字キーや数字キーのシフト状態のキーが入力できます。
- 左手の設定ボタン（T,G の右側）には、左側が USB/BLE の切り替え、右側が BLE 接続先の切り替えを割り当てています。
  - USB/BLE 切り替えは 右側の XIAO を PC と USB 接続している時のみ有効に機能します。
  - 詳しくはこちらの動画を見てください。https://youtu.be/y6X2OnoMX-M
- タッチセンサーには Trackball scroll/Pointer が割り当てられていますが、これは適当です。

![](./img/dya_dash_default_keymap.svg)
(powered by https://keymap-drawer.streamlit.app/)

### Config layer

- 左下のキー or 親指周りのキーを順に２個同時押しの状態（default->Left/right SPACE->Config とレイヤー遷移）で config layer に入ります。
- ここには普段あまり使わない設定関連のキーを割り当てます。
- 現状実験のためにとても雑に設定したものが残っており、今後調整予定です。
- 左上、右上に `&boot_loader` が割り当てられています。
  - このキーで XIAO をプログラム書き込みモードにすることができます。
  - キーボード裏側のリセットボタンをダブルクリックする必要がないので、繰り返しファームウェアを書き込む場合にとても便利です。
- 設定ボタン（内側）に `&dfnxt` が割り当てられており、このボタンで現在の接続先のデフォルトレイヤーを切り替えられます。
  - こちらの動画を見ると少しわかるかもしれません https://youtu.be/PggxfXZUtnA
  - やりたいことはこちらの記事 https://zenn.dev/shakupan/articles/261ce435251607 で紹介されていることと同じです。
  - DYA Dash では専用の ZMK ライブラリ https://github.com/cormoran/zmk-feature-default-layer を使って実現しています。
  - ※設定したら保存されるはずなのですが、なんか毎回デフォルトに戻るので何かがバグってます。原因調査予定中...
- soft off は試したのですが左でトリガーすると上手く復帰しないので無効にしてあります（マッピングを後で消す）

![](./img/dya_dash_config_keymap.svg)

### Trackball pointer/scroll layer

- トラックボールを動かすと、自動的に Trackball pointer layer が有効になります。
- トラックボールを止めると一定時間後にデフォルトレイヤーに戻ります。
- Trackball pointer layer が有効になっている間、右側のキーがマウスの右クリックや左クリックとして使えるようになります。
  - おすすめは人差し指を M キーにおいて左クリック、中指を K キーにおいて右クリックです。
  - 人差し指を J キーに置いて使うために、親指に干渉しない専用のキーキャップを設計したいとは思っています..
- 中指の下のタッチセンサーに触れると触れている間 Trackball Scrool layer が有効になります
  - この状態でトラックボールを触ると、上下左右スクロールができます。
- 薬指下のタッチセンサーは、触れている間 Trackball pointer layer が維持されるようにしたいのですが、まだうまく実装できていません。
  - 実装はやるだけなのですが、ZMK 本体パッチを当てる必要がありそうで、いい感じに実装する方法を考えているところで手が止まっています。
  - これをやるためにタッチセンサーをつけているのでそのうちやります。

![](./img/trackball_keymap.svg)

### OS ごとのデフォルトレイヤー

接続先ごとにデフォルトレイヤーを保存する機能のために、メジャーな OS ごとにデフォルト配列を設定するためのレイヤーを用意しています。
Windows, Mac で Win/Cmd を切り替える、Mac では親指内側の Cmd で英かなモード変更をできるようにするなど、作者が必要な最低限度のデフォルト設定がされています。
作者は普段 Mac を使っているので Windows での設定は現状適当です。

自動で OS 検出はできませんが、接続先ごとにデフォルトレイヤーを切り替える機能で一度手動で設定すればそれ以降は自動でデフォルトレイヤーがいい感じに切り替わることを期待しています。

![](./img/dya_dash_os_default_keymap.svg)

### Reserved レイヤー

ZMK Studio でカスタマイズできるように３つ追加のレイヤーを定義してあります。

## ZMK Studio

キーボードの右側を USB で PC と接続し、**USB 接続モードにした**状態で https://zmk.studio/ を開くと、プログラミングなしでキー配列をカスタマイズできます。

※左手の設定ボタン（左）を押すと BLE 接続モード、USB 接続モードが交互に切り替わります。USB 接続モードの場合、右手の LED が緑に光ります。

（ZMK に詳しい人向け：DYA Dash ではデフォルトで ZMK Studio によるキーマップ変更ができるように設定しており、unlock コマンドの実行は不要です）

## ファームウェアのビルド方法

zmk-config のテンプレートを用意しました。以下のレポジトリの説明を読んでください。

https://github.com/cormoran/zmk-config-dya-dash-template

## 電池持ちなど

どのくらい電池が持つかはまだ十分に検証できていません。[Power profile](../../../../powerprofile/PowerProfile.md) の結果では、キー入力をしない状態で右手が 3.81mA、左手が 1mA の電流が流れていたので、800mAh の電池を使うと、この状態をずっと放置した場合に右が１週間程度持つ計算になります。
キー入力をすると消費電力が瞬間的にかなり上がること、Deep sleep に入るとは消費電力が 1/10 程度まで下がることは確認していますが、平均消費電力などは今後まとめる予定です。

### 電源回路の補足

DAY Dash の電源回路では電池の電圧を 3.3V まで昇圧しています。電池の電圧が 1V を下回ると昇圧回路がオフになるように設計していますが、電池電圧の測定などの部分で微弱な電流が流れ続けます。電流が流れ続けると過放電の状態になるので、動かなくなるまで使い切るのではなく、電池残量が減ったら電池交換することをお勧めします。

また、電源回路には USB の電源が電池の方向に流れないようにする逆流防止回路を組み込んでいます。そのため USB 接続している時に電池の電源スイッチをオンにしても大丈夫なはずです。
一応逆流防止がうまく動いてそうなことは確認できていますが、作者は電子回路のプロではないのでうまく動かないケースがあるのではないかと少し心配しています。
なお、実装している逆流防止回路は XIAO の USB 電源回路と合わさって初めてうまく動くような設計になっています。他のマイコン（e.g. RP2040-Zero）で同じような回路を組んでもうまく動かないと思うので真似したい人は注意してください。

### LED の輝度

基板に付いている４つの LED を全力（RGB=255,255,255）で点灯させると電池に 1A 以上の電流が流れました。
（昇圧後の部分に流れている電流はもっと少ない気がしますが）回路の配線パターンは大電流を流すことをあまり考えていないため、LED を全力で点灯させていると発熱したり、最悪配線パターンが焼き切れる可能性があります。
デフォルトのソフトウェアでは最大輝度を制限していますが、ソフトウェアを改造する人は LED の輝度はほどほどにしてください。（光らせすぎると目もくらみますし...）

### バッテリー残量の予測

バッテリー残量はニッケル水素電池の電圧パターンを chat GPT に教えてもらって雑に区分線形関数近似で実現しています。
アルカリ乾電池などを常用する場合は、以下の値を変えてビルドするともっともらしい残量表示になります。

https://github.com/cormoran/dya-dash-keyboard/blob/27277f3221aaf06a4fc788ebab543c700398413d/firmware/zmk-module/zmk-keyboard-dya-dash/boards/shields/dya_dash/dya_dash.dtsi#L154

## 裏面マグネット

持ち運び時に便利なように左右のキーボードはマグネットで合わせられるようになっています。

磁力が弱く、くっついた状態で片方のキーボードのみを持ち上げると外れてしまうので注意してください（改善検討予定）

## タッチセンサー

### 感度

タッチセンサーの感度は最大の状態になっています。もし感度が高すぎる場合は、基板にコンデンサを取り付けることで調整することが可能です。
調整するつもりでコンデンサーをつけない状態にしておいたのですが、そのままでなんか良さそうなので未調整の状態です。

### 余りのポート

両方の基板に、親指付近と中指上付近にタッチセンサーの余っている２ポートにつながるパッドがあります。

動作未検証（少し無理して配線を伸ばしているので静電容量検知がうまくいかないかも）ですが、動きそうなら改造して遊んでもらえるのではないかと思います。
